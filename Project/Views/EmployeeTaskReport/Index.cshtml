@model Project.ViewModels.EmployeeTaskReportVM

<link rel="stylesheet" href="/MaterializeUI/assets/vendor/libs/tagify/tagify.css" />
@Html.AntiForgeryToken()

<div class="m-10">
    <div class="card">

        <!-- ===================== HEADER ===================== -->
        <div class="col-lg-12">
            <ul class="list-group">
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <h5 class="card-header mb-0">
                        Employee Task Report
                    </h5>
                </li>
            </ul>
        </div>

        <!-- ===================== FILTER SECTION ===================== -->
        <div class="card-body border-bottom">
            <form method="post" class="row g-3">
                @Html.AntiForgeryToken()

                <!-- Employee -->
                <div class="col-md-3">
                    <label class="form-label">Employee</label>
                    <select name="EmployeeId" class="form-select">
                        <option value="">-- All Employees --</option>
                        @foreach (var emp in ViewBag.Employees)
                        {
                            <option value="@emp.Id" selected="@(Model.EmployeeId == emp.Id)">
                                @emp.FullName (@emp.Id)
                            </option>
                        }
                    </select>
                </div>

                <!-- Status -->
                <div class="col-md-2">
                    <label class="form-label">Status</label>
                    <select name="Status" class="form-select">
                        <option value="">-- All --</option>
                        <option value="Pending" selected="@(Model.Status == "Pending")">Pending</option>
                        <option value="Completed" selected="@(Model.Status == "Completed")">Completed</option>
                    </select>
                </div>

                <!-- From Date (Assigned Date) -->
                <div class="col-md-2">
                    <label class="form-label">Assigned From</label>
                    <input type="date"
                           name="FromDate"
                           class="form-control"
                           value="@(Model.FromDate?.ToString("yyyy-MM-dd"))" />
                </div>

                <!-- To Date (User Input) -->
                <div class="col-md-2">
                    <label class="form-label">Assigned To</label>
                    <input type="date"
                           name="ToDate"
                           class="form-control"
                           value="@(Model.ToDate?.ToString("yyyy-MM-dd"))" />
                </div>

                <!-- Filter Button -->
                <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-primary w-100">
                        Filter Report
                    </button>
                </div>
            </form>
        </div>

        <!-- ===================== TABLE ===================== -->
        <div class="table-wrapper position-relative responsive-table table-scroll">
            <table class="table table-bordered table-striped mt-3">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Employee Name</th>
                        <th>Task Title</th>
                        <th>Date Assigned</th>
                        <th>Status</th>
                    </tr>
                </thead>

                <tbody>
                    @if (Model.Results != null && Model.Results.Any())
                    {
                        // Group first by employee, then by date
                        var groupedByEmployee = Model.Results
                        .GroupBy(r => r.Employee)
                        .ToList();

                        foreach (var employeeGroup in groupedByEmployee)
                        {
                            var employee = employeeGroup.Key;

                            // Further group by date
                            var groupedByDate = employeeGroup
                            .GroupBy(t => t.DateAssigned.Date)
                            .OrderBy(g => g.Key); // sort by date

                            foreach (var dateGroup in groupedByDate)
                            {
                                <tr>
                                    <td>@employee?.Id</td>
                                    <td>@employee?.FullName</td>

                                    <!-- Tasks column with badges -->
                                    <td>
                                        @foreach (var task in dateGroup)
                                        {
                                            <span class="badge @(task.Status == "Completed" ? "bg-success" : task.Status == "Pending" ? "bg-warning text-dark" : "bg-secondary") me-1 mb-1">
                                                @task.Task?.Title
                                            </span>
                                        }
                                    </td>

                                    <!-- Assigned Date column -->
                                    <td>@dateGroup.Key.ToString("yyyy-MM-dd")</td>
                                </tr>
                            }
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="4" class="text-center text-muted">No records found</td>
                        </tr>
                    }
                </tbody>





            </table>
        </div>

    </div>
</div>
